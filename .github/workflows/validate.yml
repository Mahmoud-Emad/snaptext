name: Validate Workflows

on:
  push:
    paths:
      - '.github/workflows/**'
  pull_request:
    paths:
      - '.github/workflows/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate workflow syntax
      run: |
        echo "ðŸ” Validating GitHub Actions workflow syntax..."

        # Check if workflows directory exists
        if [ ! -d ".github/workflows" ]; then
          echo "âŒ .github/workflows directory not found"
          exit 1
        fi

        # Count workflow files
        WORKFLOW_COUNT=$(find .github/workflows -name "*.yml" -o -name "*.yaml" | wc -l)
        echo "ðŸ“ Found $WORKFLOW_COUNT workflow files"

        # List all workflow files
        echo "ðŸ“‹ Workflow files:"
        find .github/workflows -name "*.yml" -o -name "*.yaml" | sort

        # Basic YAML syntax validation
        echo ""
        echo "âœ… Basic YAML syntax validation:"
        for file in .github/workflows/*.yml .github/workflows/*.yaml; do
          if [ -f "$file" ]; then
            echo "  Checking $(basename "$file")..."
            python -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
          fi
        done

        echo ""
        echo "ðŸŽ‰ All workflow files have valid YAML syntax!"

    - name: Check workflow completeness
      run: |
        echo "ðŸ” Checking workflow completeness..."

        # Check for required workflows
        REQUIRED_WORKFLOWS=("test.yml" "lint.yml" "ci.yml")

        for workflow in "${REQUIRED_WORKFLOWS[@]}"; do
          if [ -f ".github/workflows/$workflow" ]; then
            echo "âœ… Found required workflow: $workflow"
          else
            echo "âŒ Missing required workflow: $workflow"
            exit 1
          fi
        done

        echo ""
        echo "ðŸŽ‰ All required workflows are present!"

    - name: Validate action versions
      run: |
        echo "ðŸ” Checking for deprecated action versions..."

        # Check for deprecated actions (excluding this validation file)
        DEPRECATED_UPLOAD_V3=$(find .github/workflows -name "*.yml" -not -name "validate.yml" -exec grep -l "actions/upload-artifact@v3" {} \;)
        if [ -n "$DEPRECATED_UPLOAD_V3" ]; then
          echo "âŒ Found deprecated actions/upload-artifact@v3 in:"
          echo "$DEPRECATED_UPLOAD_V3"
          echo "Please update to actions/upload-artifact@v4"
          exit 1
        fi

        # Check for deprecated actions/cache@v3
        DEPRECATED_CACHE_V3=$(find .github/workflows -name "*.yml" -not -name "validate.yml" -exec grep -l "actions/cache@v3" {} \;)
        if [ -n "$DEPRECATED_CACHE_V3" ]; then
          echo "âš ï¸ Found actions/cache@v3 in:"
          echo "$DEPRECATED_CACHE_V3"
          echo "Consider updating to v4"
        fi

        # Check for deprecated actions/setup-python@v4
        DEPRECATED_PYTHON_V4=$(find .github/workflows -name "*.yml" -not -name "validate.yml" -exec grep -l "actions/setup-python@v4" {} \;)
        if [ -n "$DEPRECATED_PYTHON_V4" ]; then
          echo "â„¹ï¸ Found actions/setup-python@v4 in:"
          echo "$DEPRECATED_PYTHON_V4"
          echo "Consider updating to v5"
        fi

        echo "âœ… No deprecated action versions found!"

    - name: Check workflow triggers
      run: |
        echo "ðŸ” Validating workflow triggers..."

        # Check that main workflows have proper triggers
        for workflow in test.yml lint.yml ci.yml; do
          if [ -f ".github/workflows/$workflow" ]; then
            echo "Checking triggers for $workflow:"

            # Check for push trigger
            if grep -q "push:" ".github/workflows/$workflow"; then
              echo "  âœ… Has push trigger"
            else
              echo "  âš ï¸ Missing push trigger"
            fi

            # Check for pull_request trigger
            if grep -q "pull_request:" ".github/workflows/$workflow"; then
              echo "  âœ… Has pull_request trigger"
            else
              echo "  âš ï¸ Missing pull_request trigger"
            fi
          fi
        done

        echo ""
        echo "ðŸŽ‰ Workflow trigger validation complete!"

    - name: Summary
      run: |
        echo "## Workflow Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **YAML Syntax**: All workflows have valid YAML syntax" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Completeness**: All required workflows are present" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Action Versions**: No deprecated actions found" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Triggers**: Workflows have appropriate triggers" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ‰ **All validations passed!**" >> $GITHUB_STEP_SUMMARY
